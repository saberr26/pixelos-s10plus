name: Build PixelOS for Galaxy S10+

on:
  workflow_dispatch:  # Manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Clean up space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
    
    - name: Set up build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex \
          g++-multilib gcc-multilib git git-lfs gnupg gperf imagemagick \
          lib32stdc++6 lib32z1 lib32z1-dev liblz4-tool \
          libncurses6 libncurses-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev \
          openjdk-11-jdk python3 python-is-python3 \
          libc6-dev-i386 libx11-dev libgl1-mesa-dev
    
    - name: Set up repo tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
    
    - name: Initialize PixelOS repo
      run: |
        mkdir ~/pixelos
        cd ~/pixelos
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        repo init -u https://github.com/PixelOS-AOSP/android_manifest -b sixteen --depth=1
    
    - name: Copy local manifests
      run: |
        mkdir -p ~/pixelos/.repo/local_manifests
        cp $GITHUB_WORKSPACE/local_manifests/*.xml ~/pixelos/.repo/local_manifests/
    
    - name: Sync sources
      run: |
        cd ~/pixelos
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
    
    - name: Build ROM
      run: |
        cd ~/pixelos
        source build/envsetup.sh
        lunch aosp_beyond2lte-ap2a-userdebug
        mka bacon -j$(nproc --all)
    
    - name: Upload ROM
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: PixelOS-beyond2lte
        path: ~/pixelos/out/target/product/beyond2lte/PixelOS*.zip
